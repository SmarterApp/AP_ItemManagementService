/*
 *  Copyright 2017 Regents of the University of California.
 *
 *  Licensed under the Educational Community License, Version 2.0 (the "license");
 *  you may not use this file except in compliance with the License. You may
 *  obtain a copy of the license at
 *
 *  https://opensource.org/licenses/ECL-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 */
package org.opentestsystem.ap.ims.util;

import com.google.common.collect.Lists;
import freemarker.template.Configuration;
import freemarker.template.TemplateExceptionHandler;
import lombok.Getter;
import lombok.extern.slf4j.Slf4j;
import org.opentestsystem.ap.common.assembler.AppAssembler;
import org.opentestsystem.ap.common.config.ItemBankProperties;
import org.opentestsystem.ap.common.model.AssessmentItem;
import org.opentestsystem.ap.common.model.Item;
import org.opentestsystem.ap.common.model.ModelConstants;
import org.opentestsystem.ap.common.model.ItemFactory;
import org.opentestsystem.ap.common.model.ItemResponse;
import org.opentestsystem.ap.common.model.ItemTransaction;
import org.opentestsystem.ap.common.model.JsonModelAssembler;
import org.opentestsystem.ap.common.model.SaItem;
import org.opentestsystem.ap.common.saaif.ItemContext;
import org.opentestsystem.ap.common.saaif.SaaifAssembler;
import org.opentestsystem.ap.common.saaif.SaaifMetadataAssembler;
import org.opentestsystem.ap.common.saaif.SaaifWordListAssembler;
import org.opentestsystem.ap.common.saaif.StringAssembler;
import org.opentestsystem.ap.common.saaif.item.AssociatedStimulusSupplier;
import org.opentestsystem.ap.common.saaif.transformer.TransformerFactory;
import org.opentestsystem.ap.common.security.model.ItemBankUser;
import org.opentestsystem.ap.common.util.DefaultImageGenerator;
import org.opentestsystem.ap.ims.rest.ItemChangeRequest;

import java.io.File;
import java.io.IOException;
import java.nio.file.FileVisitOption;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.Comparator;
import java.util.List;
import java.util.Optional;

import static com.google.common.collect.Lists.newArrayList;
import static org.mockito.Matchers.isA;
import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.when;
import static org.opentestsystem.ap.common.model.ModelConstants.ItemType.TYPE_SA;
import static org.opentestsystem.ap.common.model.ModelConstants.Section.SECTION_BRAILLE;
import static org.opentestsystem.ap.common.model.ModelConstants.Section.SECTION_CORE;

/**
 * When instantiated the utility creates a temp directory and another directory in it. These represent the local repo
 * base and a local repository.  There is a cleanup method intended for tests during tear down.
 */
@Slf4j
@Getter
public class IMSTestUtil {

    private ItemFactory itemFactory = new ItemFactory();

    private TransformerFactory transformerFactory;

    // ------------------------------------------------------------------------

    public static final String SECTION = ModelConstants.Section.SECTION_CORE;

    public static final ItemBankUser ITEM_BANK_USER = new ItemBankUser("hal_jordan@fairwaytech.com", "Hal Jordan");

    public static final ItemBankUser ITEM_BANK_USER2 = new ItemBankUser("clark_kent@fairwaytech.com", "Clark Kent");

    public static final Integer GROUP_ID = 8765309;

    public static final Integer PROJECT_ID = 11;

    public static final String ITEM_ID = "200000";

    public static final String BANK_KEY = "200";

    public static final String LEGACY_ID = String.format("item-%s-%s", BANK_KEY, ITEM_ID);

    public static final String FIELD_PATH = "core.en.prompt";

    public static final String TRANSACTION_ID = "testTransactionId";

    public static final ItemTransaction ITEM_AUTHOR = new ItemTransaction(ITEM_BANK_USER.getUserName(), SECTION_CORE);

    public static final String HISTORY_ID = "testHistoryId";

    public static final String ITEM_BANK_HOST = "http://itembank.com";

    public static final String API_VERSION = "/api/version";


    public static final String COMMIT_MESSAGE = "this is a commit message";

    public static final String PROMPT = "This is a prompt";

    public static final String PROMPT_RICH_TEXT = "<p style=\"font-weight: bold;\">This is a rich text prompt</p>";

    public static final String EXEMPLAR_RESPONSE_1 = "This is an exemplar response 1";

    public static final String EXEMPLAR_RESPONSE_2 = "This is an exemplar response 2";

    public static final String WORKFLOW_STATUS_DRAFT = "Draft";

    public static final String SYSTEM_VERSION = "iat-42";


    // ------------------------------------------------------------------------

    private ItemBankProperties gitlabProperties;

    private Path localBaseDir;

    private Path localRepoDir;

    private String gitlabHost = "https://gitlab-dev.smarterbalanced.org";

    private String gitlabUser = "test@fake.com";

    private String gitlabPass = "testPassword";

    private String gitlabGroup = "TestItembankGroup";

    private String gitLabProject = ITEM_ID;

    private int idMinValue = 1000000000;

    private int idMaxValue = Integer.MAX_VALUE;

    private Configuration freemarker;

    private SaaifAssembler saaifAssembler;

    private SaaifMetadataAssembler metadataAssembler;

    private SaaifWordListAssembler wordListAssembler;

    private JsonModelAssembler jsonModelAssembler;

    private AppAssembler assembler;

    private StringAssembler stringAssembler;

    private ItemContext itemContext;

    private DefaultImageGenerator imageGenerator = new DefaultImageGenerator();

    /**
     * Creates a temporary directory using a prefix of <code>gitlabGroup</code>. A directory is created in the temp
     * directory with the name <code>gitLabProject</code>. The <code>GitlabProperties</code> instance is created with
     * the default values set on the class's instance properties.
     */
    public IMSTestUtil() {
        init();
    }

    /**
     * Same as the default constructor but instead of using default values the class's instance properties are first set
     * with the arguments of the constructor.
     */
    public IMSTestUtil(String gitlabHost, String gitlabUser, String gitlabPass, String gitlabGroup,
                       String gitLabProject, int idMinValue, int idMaxValue) {
        this.gitlabHost = gitlabHost;
        this.gitlabUser = gitlabUser;
        this.gitlabPass = gitlabPass;
        this.gitlabGroup = gitlabGroup;
        this.gitLabProject = gitLabProject;
        this.idMinValue = idMinValue;
        this.idMaxValue = idMaxValue;

        init();
    }

    private void init() {
        try {
            localBaseDir = Files.createTempDirectory(gitlabGroup);
            localRepoDir = Files.createDirectories(
                    Paths.get(localBaseDir.toString(), ITEM_BANK_USER.parseUsername(), gitLabProject));
        } catch (IOException e) {
            throw new RuntimeException(e);
        }

        gitlabProperties = new ItemBankProperties();
        gitlabProperties.setGroup(gitlabGroup);
        gitlabProperties.setHost(gitlabHost);
        gitlabProperties.setIdMinValue(idMinValue);
        gitlabProperties.setIdMaxValue(idMinValue);
        gitlabProperties.setUser(gitlabUser);
        gitlabProperties.setPassword(gitlabUser);
        gitlabProperties.setLocalBaseDir(localBaseDir.toString());
        gitlabProperties.setSystemVersion(SYSTEM_VERSION);

        freemarker = new Configuration(Configuration.VERSION_2_3_25);
        freemarker.setClassForTemplateLoading(this.getClass(), "/saaif_templates");
        freemarker.setTemplateExceptionHandler(TemplateExceptionHandler.RETHROW_HANDLER);
        freemarker.setDefaultEncoding("UTF-8");

        stringAssembler = new StringAssembler(freemarker);

        metadataAssembler = new SaaifMetadataAssembler();
        metadataAssembler.init();

        wordListAssembler = new SaaifWordListAssembler();
        wordListAssembler.init();

        saaifAssembler = new SaaifAssembler(metadataAssembler, wordListAssembler);
        saaifAssembler.init();

        jsonModelAssembler = new JsonModelAssembler();

        assembler = new AppAssembler(saaifAssembler,jsonModelAssembler, stringAssembler);

        itemContext = new ItemContext(ITEM_ID, LEGACY_ID, BANK_KEY, assembler, localRepoDir);

        AssociatedStimulusSupplier supplier = mock(AssociatedStimulusSupplier.class);
        when(supplier.getAssociatedStimulus(isA(AssessmentItem.class))).thenReturn(Optional.empty());

        transformerFactory = new TransformerFactory(supplier);
    }

    // ------------------------------------------------------------------------

    /**
     * Deletes the temp directory and all its contents.
     */
    public void cleanup() {
        deleteDirectory(localBaseDir);
    }

    public void deleteDirectory(Path directoryToDelete) {
        if (Files.exists(directoryToDelete) && Files.isDirectory(directoryToDelete)) {
            log.info("deleting {}", directoryToDelete.toString());
            try {
                Files.walk(directoryToDelete, FileVisitOption.FOLLOW_LINKS)
                    .sorted(Comparator.reverseOrder())
                    .map(Path::toFile)
                    .peek(System.out::println)
                    .forEach(File::delete);
            } catch (Exception e) {
                throw new RuntimeException("Error trying to delete a directory", e);
            }
        }
    }

    // ------------------------------------------------------------------------

    public ItemChangeRequest newItemChangeRequest() {
        final SaItem item = newSaItem();
        item.getWorkflow().setWorkflowStatusCode(WORKFLOW_STATUS_DRAFT);
        final ItemChangeRequest req = new ItemChangeRequest();
        req.setMessage(COMMIT_MESSAGE);
        req.setItem(item);
        return req;
    }

    public ItemChangeRequest newItemFieldChangeRequest() {
        final SaItem item = newSaItem();
        item.getWorkflow().setWorkflowStatusCode(WORKFLOW_STATUS_DRAFT);
        final ItemChangeRequest req = new ItemChangeRequest();
        req.setMessage(COMMIT_MESSAGE);
        req.setOldValue("old value");
        req.setNewValue("new value");
        return req;
    }

    public List<ItemTransaction> newItemTransactionList() {
        return Lists.newArrayList(
            newItemTransaction(),
            newItemTransaction(ITEM_BANK_USER2.getUserName(), SECTION_BRAILLE)
        );
    }

    /**
     * Creates a new item transaction using 'core' section and the test item bank user username.
     *
     * @return The item transaction.
     */
    public ItemTransaction newItemTransaction() {
        return newItemTransaction(ITEM_BANK_USER.getUserName(), SECTION_CORE);
    }

    /**
     * New item transaction.
     *
     * @param username The transaction username.
     * @param section  The transaction section.
     * @return The item transaction.
     */
    public ItemTransaction newItemTransaction(final String username, final String section) {
        return new ItemTransaction(username, section);
    }

    public ItemResponse newItemResponse() {
        final Item item = newSaItem();
        return new ItemResponse(item, newItemTransactionList());
    }

    // ------------------------------------------------------------------------

    public SaItem newSaItem() {
        final SaItem item = (SaItem) itemFactory.newItem(ITEM_ID, TYPE_SA);
        item.getCore().getEn().setPrompt(PROMPT);
        item.getCore().getEn().setExemplarResponses(newArrayList(EXEMPLAR_RESPONSE_1, EXEMPLAR_RESPONSE_2));
        return item;
    }
}
