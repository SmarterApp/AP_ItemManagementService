package org.opentestsystem.ap.ims.rest.v1;

import io.swagger.annotations.Api;
import lombok.extern.slf4j.Slf4j;
import org.opentestsystem.ap.ims.model.SavedSearchModel;
import org.opentestsystem.ap.ims.service.SavedSearchService;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.List;

@Slf4j
@RestController
@RequestMapping("/api/v1/items/savedSearch")
@Api
public class SavedSearchApi {

    private final SavedSearchService savedSearchService;

    public SavedSearchApi(final SavedSearchService savedSearchService) {
        this.savedSearchService = savedSearchService;
    }

    // ------------------------------------------------------------------------
    // Saved Search
    // ------------------------------------------------------------------------

    @PostMapping
    public void createSavedSearch(@RequestBody final SavedSearchModel.SaveSearchRequest model) {
        log.debug("create saved search");
        savedSearchService.createSavedSearch(model);
    }

    @GetMapping
    public List<SavedSearchModel.SavedSearchResponse> retrieveSavedSearches() {
        log.debug("retrieve saved searches");
        List<SavedSearchModel.SavedSearchResponse> savedSearches = savedSearchService.findSavedSearches();
        savedSearches.addAll(savedSearchService.findSavedSearchesBySharedWithUserName());
        return savedSearches;
    }

    @DeleteMapping("/{searchName}")
    public void deleteSavedSearch(@PathVariable final String searchName) {
        log.debug("delete saved search");
        savedSearchService.deleteMySavedSearch(searchName);
    }

    // ------------------------------------------------------------------------
    // Shared Saved Search
    // ------------------------------------------------------------------------

    @PostMapping("/{searchName}/share")
    public void createSavedSearch(@PathVariable final String searchName,
                                  @RequestBody final SavedSearchModel.SharedSearchRequest model) {
        log.debug("create shared saved search");
        model.setSearchName(searchName);
        savedSearchService.shareSavedSearch(model);
    }

    @GetMapping("/{searchName}/share")
    public List<SavedSearchModel.SharedSavedSearchResponse> retrieveSharedSavedSearches(@PathVariable final String searchName) {
        log.debug("retrieve shared saved searches");
        return savedSearchService.findSharedSavedSearches(searchName);
    }

    @DeleteMapping("/{searchName}/share")
    public void deleteSavedSearch(@ModelAttribute final SavedSearchModel.UnShareSearchRequest model) {
        log.debug("delete shared saved search");
        savedSearchService.unshareSavedSearch(model);

    }
}

