package org.opentestsystem.ap.ims.service.export.writer;

import com.itextpdf.html2pdf.ConverterProperties;
import com.itextpdf.kernel.pdf.PdfWriter;
import com.itextpdf.layout.Document;
import org.apache.commons.lang3.StringUtils;
import org.opentestsystem.ap.common.model.Item;
import org.opentestsystem.ap.common.model.ItemConstants;
import org.opentestsystem.ap.common.model.TiItem;
import org.opentestsystem.ap.ims.model.export.AdditionalInfo;
import org.opentestsystem.ap.ims.model.export.Cell;
import org.opentestsystem.ap.ims.model.export.ItemExport;
import org.opentestsystem.ap.ims.model.export.MiExportData;
import org.opentestsystem.ap.ims.model.export.Row;
import org.opentestsystem.ap.ims.model.export.Table;
import org.opentestsystem.ap.ims.model.export.TableAnswer;
import org.opentestsystem.ap.ims.model.export.TableHeader;
import org.springframework.stereotype.Component;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@Component
public class TiItemContentWriter extends PdfContentWriter implements ItemContentWriter {
    private static final String template = "ti-export";

    @Override
    public boolean supportsItemType(final Item item) {
        return item instanceof TiItem;
    }

    @Override
    public void addContent(final PdfWriter pdfWriter, final Document document, ConverterProperties properties, ItemExport itemExport) {
        TiItem item = (TiItem) itemExport.getItem();

        String promptContent = getPromptContent(itemExport.getItemRelease());
        AdditionalInfo additionalInfo = AdditionalInfo.create(itemExport);

        org.opentestsystem.ap.common.model.Table englishTable = item.getCore().getEn().getTable();
        org.opentestsystem.ap.common.model.Table spanishTable = null;

        if(item.getTranslations() != null && item.getTranslations().getEsp() != null && item.getTranslations().getEsp().getTable() != null) {
            spanishTable = item.getTranslations().getEsp().getTable();
        }

        TiItemContentWriter.TableHolder holder = buildTable(itemExport, englishTable, spanishTable);

        MiExportData exportData = new MiExportData(item.getId(), promptContent, additionalInfo, itemExport.isIncludeRubrics(), holder.table, holder.tableAnswers);

        Map<String, Object> data = new HashMap<>();
        data.put("data", exportData);

        String html = convertHtml(template, data);

        //TODO - Remove before final commit
        writeHtmlToFile(itemExport, html);

        addHtmlToPdf(document, properties, itemExport, html);
    }

    private List<TableHeader> buildTableHeaders(ItemExport itemExport, org.opentestsystem.ap.common.model.Table englishTable, org.opentestsystem.ap.common.model.Table spanishTable) {
        List<TableHeader> headers = new ArrayList<>();
        List<org.opentestsystem.ap.common.model.Table.Column> englishColumns = englishTable.getColumns();
        List<org.opentestsystem.ap.common.model.Table.Column> spanishColumns = new ArrayList<>();

        if (spanishTable != null) {
            spanishColumns = spanishTable.getColumns();
        }

        List<org.opentestsystem.ap.common.model.Table.Column> largerColumnList = englishColumns.size() > spanishColumns.size() ? englishColumns : spanishColumns;

        for (int i = 0; i < largerColumnList.size(); i++) {
            String spanishHeaderText = spanishColumns.size() > i ? spanishColumns.get(i).getLabel() : StringUtils.EMPTY;
            String englishHeaderText = englishColumns.size() > i ? englishColumns.get(i).getLabel() : StringUtils.EMPTY;

            if (StringUtils.isNotBlank(spanishHeaderText) || StringUtils.isNotBlank(englishHeaderText)) {
                TableHeader header = new TableHeader(translateEnglishContent(itemExport, englishHeaderText), translateSpanishContent(itemExport, spanishHeaderText));
                headers.add(header);
            }
        }

        return headers;
    }

    private TiItemContentWriter.TableHolder buildTable(ItemExport itemExport, org.opentestsystem.ap.common.model.Table englishTable, org.opentestsystem.ap.common.model.Table spanishTable) {
        List<Row> rows = new ArrayList<>();
        List<TableAnswer> tableAnswers = new ArrayList<>();
        List<org.opentestsystem.ap.common.model.Table.Row> englishRows = englishTable.getRows();
        List<org.opentestsystem.ap.common.model.Table.Row> spanishRows = new ArrayList<>();
        String englishTitle = translateEnglishContent(itemExport, englishTable.getTitle());
        String spanishTitle = StringUtils.EMPTY;

        if (spanishTable != null) {
            spanishRows = spanishTable.getRows();
            spanishTitle = translateSpanishContent(itemExport, spanishTable.getTitle());
        }

        List<org.opentestsystem.ap.common.model.Table.Row> largerRowList = englishRows.size() > spanishRows.size() ? englishRows : spanishRows;

        /*
         There is no guarantee that rows/cells will be consistent across
         English and Spanish item content
         */
        for (int i = 0; i < largerRowList.size(); i++) {
            int rowNumber = i + 1;
            List<org.opentestsystem.ap.common.model.Table.Cell> spanishCells = spanishRows.size() > i ? spanishRows.get(i).getCells() : new ArrayList<>();
            List<org.opentestsystem.ap.common.model.Table.Cell> englishCells = englishRows.size() > i ? englishRows.get(i).getCells() : new ArrayList<>();

            List<TiItemContentWriter.CellHolder> cellHolders = buildCells(itemExport, englishCells, spanishCells);
            List<Cell> cells = new ArrayList<>();

            for (int j = 0; j < cellHolders.size(); j++) {
                CellHolder cellHolder = cellHolders.get(j);
                cells.add(cellHolder.cell);

                if (cellHolder.correctAnswer) {
                    tableAnswers.add(new TableAnswer(rowNumber, j + 1, cellHolder.answerValue));
                }
            }

            rows.add(new Row(cells));
        }

        return new TiItemContentWriter.TableHolder(new Table(buildTableHeaders(itemExport, englishTable, spanishTable), rows, englishTitle, spanishTitle), tableAnswers);
    }

    private List<TiItemContentWriter.CellHolder> buildCells(ItemExport itemExport, List<org.opentestsystem.ap.common.model.Table.Cell> englishCells, List<org.opentestsystem.ap.common.model.Table.Cell> spanishCells) {
        List<org.opentestsystem.ap.common.model.Table.Cell> largerCellList = englishCells.size() > spanishCells.size() ? englishCells : spanishCells;

        List<TiItemContentWriter.CellHolder> outputCells = new ArrayList<>();

        for (int j = 0; j < largerCellList.size(); j++) {
            Cell cell;
            boolean correctAnswer = englishCells.size() > j && englishCells.get(j).isCorrectAnswer();
            String cellType = largerCellList.get(j).getType();
            org.opentestsystem.ap.common.model.Table.Cell englishCell = englishCells.size() > j ? englishCells.get(j) : null;
            org.opentestsystem.ap.common.model.Table.Cell spanishCell = spanishCells.size() > j ? spanishCells.get(j) : null;

            if (ItemConstants.CellType.CELL_TYPE_LABEL.equals(cellType)) {
                String englishText = StringUtils.EMPTY;
                String spanishText = StringUtils.EMPTY;
                if (englishCell != null) {
                    englishText = translateEnglishContent(itemExport, (String) englishCell.getValue());
                }

                if (spanishCell != null) {
                    spanishText = translateSpanishContent(itemExport, (String) spanishCell.getValue());
                }

                cell = new Cell(cellType, englishText, spanishText);
            } else {
                cell = new Cell(cellType);
            }

            String answerValue = StringUtils.EMPTY;
            if(englishCell != null
                    && englishCell.isCorrectAnswer()
                    && englishCell.getValue() instanceof String) {
                answerValue = (String) englishCell.getValue();
            }

            outputCells.add(new TiItemContentWriter.CellHolder(cell, correctAnswer, answerValue));
        }

        return outputCells;
    }

    private static class TableHolder {
        private Table table;
        private List<TableAnswer> tableAnswers;

        TableHolder(final Table table, final List<TableAnswer> tableAnswers) {
            this.table = table;
            this.tableAnswers = tableAnswers;
        }
    }

    private static class CellHolder {
        private Cell cell;
        private boolean correctAnswer;
        private String answerValue;

        CellHolder(final Cell cell, final boolean correctAnswer, final String answerValue) {
            this.cell = cell;
            this.correctAnswer = correctAnswer;
            this.answerValue = answerValue;
        }
    }
}
