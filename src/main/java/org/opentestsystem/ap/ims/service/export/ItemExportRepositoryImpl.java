package org.opentestsystem.ap.ims.service.export;

import org.opentestsystem.ap.common.assembler.AppAssembler;
import org.opentestsystem.ap.common.client.GitClient;
import org.opentestsystem.ap.common.config.ItemBankProperties;
import org.opentestsystem.ap.common.util.SecurityUtil;
import org.springframework.stereotype.Repository;

import java.nio.file.Path;

@Repository
public class ItemExportRepositoryImpl implements ItemExportRepository {
    private final AppAssembler appAssembler;
    private final SecurityUtil securityUtil;
    private final ItemBankProperties itemBankProperties;

    public ItemExportRepositoryImpl(final AppAssembler appAssembler, final SecurityUtil securityUtil, final ItemBankProperties itemBankProperties) {
        this.appAssembler = appAssembler;
        this.securityUtil = securityUtil;
        this.itemBankProperties = itemBankProperties;
    }

    @Override
    public Path cloneItemForExport(final Path exportDirectory, final String itemId) {
        //TODO - This currently goes to Gitlab but should be changed to leverage the new IAT data source
        GitClient gitClient = GitClient.newGitClientNoParentFolderAndCustomDirectory(
                itemBankProperties,
                securityUtil.getItemBankUser(),
                itemId, appAssembler,
                exportDirectory.toString());

        gitClient.cloneRemoteRepository();

        return gitClient.getLocalRepositoryPath();
    }
}
