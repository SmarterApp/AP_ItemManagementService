package org.opentestsystem.ap.ims.service;

import lombok.extern.slf4j.Slf4j;
import org.opentestsystem.ap.common.util.SecurityUtil;
import org.opentestsystem.ap.ims.entity.SavedSearch;
import org.opentestsystem.ap.ims.entity.SavedSearch.SavedSearchIdentity;
import org.opentestsystem.ap.ims.model.SavedSearchModel;
import org.opentestsystem.ap.ims.repository.SavedSearchRepository;
import org.springframework.data.domain.Sort;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.Objects;
import java.util.function.Function;
import java.util.stream.Collectors;

@Slf4j
@Service
public class SavedSearchService {

    private final SavedSearchRepository savedSearchRepository;

    public SavedSearchService(final SavedSearchRepository savedSearchRepository) {
        this.savedSearchRepository = savedSearchRepository;
    }

    // ------------------------------------------------------------------------
    // Saved Search Public Methods
    // ------------------------------------------------------------------------

    public void saveSavedSearch(final SavedSearchModel.SaveSearchRequest model) {
        log.debug("create saved search '{}' for {}", model.getSearchName(), model.getUserName());
        final SavedSearch savedSearch = new SavedSearch(newIdentity(model), model.getSearchJson());
        savedSearchRepository.save(savedSearch);
    }

    @Transactional(readOnly = true)
    public List<SavedSearchModel.SavedSearchResponse> findSavedSearches(final String userName) {
        log.debug("find saved searches for {}", userName);
        final List<SavedSearch> results = savedSearchRepository.findByIdUserName(userName, orderBySearchName());
        return results.stream().map(toSavedSearchModel).collect(Collectors.toList());
    }

    public void deleteSavedSearch(final String userName, final String searchName) {
        log.debug("delete saved search '{}' for {}", searchName, userName);
        final SavedSearchIdentity id = newIdentity(userName, searchName);
        final SavedSearch savedSearch = savedSearchRepository.findOne(id);
        if (Objects.nonNull(savedSearch)) {
            savedSearchRepository.delete(savedSearch);
        }
    }

    // ------------------------------------------------------------------------
    // Helper Methods
    // ------------------------------------------------------------------------

    private Function<SavedSearch, SavedSearchModel.SavedSearchResponse> toSavedSearchModel = entity ->
        new SavedSearchModel.SavedSearchResponse(
            entity.getId().getUserName(),
            entity.getId().getSearchName(),
            entity.getSearchJson());

    private SavedSearchIdentity newIdentity(final SavedSearchModel.SaveSearchRequest model) {
        return newIdentity(model.getUserName(), model.getSearchName());
    }

    private SavedSearchIdentity newIdentity(final String userName, final String searchName) {
        return new SavedSearchIdentity(userName, searchName);
    }

    private Sort orderBySearchName() {
        return new Sort(Sort.Direction.ASC, "id.searchName");
    }
}
