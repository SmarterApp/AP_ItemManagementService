package org.opentestsystem.ap.ims.service.export;

import com.itextpdf.text.Document;
import com.itextpdf.text.DocumentException;
import com.itextpdf.text.pdf.PdfWriter;
import io.woo.htmltopdf.HtmlToPdf;
import io.woo.htmltopdf.HtmlToPdfObject;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang.StringUtils;
import org.opentestsystem.ap.common.exception.ValidationException;
import org.opentestsystem.ap.common.model.ItemBankUser;
import org.opentestsystem.ap.common.model.ItemResponse;
import org.opentestsystem.ap.common.model.PreviewData;
import org.opentestsystem.ap.common.model.WerItem;
import org.opentestsystem.ap.common.repository.ItemRepository;
import org.opentestsystem.ap.ims.service.ItemService;
import org.springframework.boot.web.client.RestTemplateBuilder;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.nio.file.FileVisitResult;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.nio.file.SimpleFileVisitor;
import java.nio.file.attribute.BasicFileAttributes;
import java.util.Collection;
import java.util.Optional;
import java.util.UUID;
import java.util.zip.ZipEntry;
import java.util.zip.ZipOutputStream;

import static org.opentestsystem.ap.common.model.ItemConstants.ItemType.TYPE_TUT;

@Slf4j
@Service
public class ItemExportServiceImpl implements ItemExportService {
    private final ItemService itemService;
    private final Collection<ItemContentWriter> itemContentWriters;
    private final ItemRepository itemRepository;
    private final RestTemplate restTemplate;

    public ItemExportServiceImpl(final ItemService itemService, final Collection<ItemContentWriter> itemContentWriters, final ItemRepository itemRepository, final RestTemplateBuilder restTemplate) {
        this.itemService = itemService;
        this.itemContentWriters = itemContentWriters;
        this.itemRepository = itemRepository;
        this.restTemplate = restTemplate.build();
    }

    @Override
    public Optional<File> exportItem(final String itemId) {
        final ItemResponse itemResponse = itemService.findItem(itemId);

        if (itemResponse.getItem() == null) {
            return Optional.empty();
        } else if (itemResponse.getItem().getType().equals(TYPE_TUT)) {
            throw new ValidationException(TYPE_TUT + " type is not supported");
        }

        doSomethin(itemId);

        try {
            Path path = Files.createTempDirectory(UUID.randomUUID().toString());

            File itemFiles = new File(path.toFile(), "itemFiles");
            itemFiles.mkdir();
            File zipFile = new File(path.toFile(),itemId + ".zip");

            createPdf(itemFiles, itemResponse);
            createOtherPdf(itemFiles, itemResponse);
            getPreview(itemFiles, itemId);
            pack(Paths.get(itemFiles.toURI()), Paths.get(zipFile.toURI()));

            return Optional.of(zipFile);
        } catch (IOException ioe) {
            throw new RuntimeException("Unhandled Exception when exporting item", ioe);
        }


    }

    private void createPdf(File directory, ItemResponse itemResponse) throws IOException {
        final String pdfName = itemResponse.getItem().getId() + ".pdf";
        File pdfFile = new File(directory, pdfName);
        pdfFile.createNewFile();

        try (FileOutputStream fos = new FileOutputStream(pdfFile)) {

            Document document = new Document();
            PdfWriter pdfWriter = PdfWriter.getInstance(document, fos);

            document.open();

            for (ItemContentWriter contentWriter : itemContentWriters) {
                if(contentWriter.supportsItemType(itemResponse.getItem())) {
                   contentWriter.addContent(itemResponse.getItem(), pdfWriter, document);
                   break;
                }
            }

            document.close();
        } catch (DocumentException | IOException e) {
            throw new RuntimeException("Unexpected issue creating the pdf", e);
        }
    }

    private void createOtherPdf(File directory, ItemResponse itemResponse) {
        boolean success = HtmlToPdf.create()
                .object(HtmlToPdfObject.forHtml(((WerItem) itemResponse.getItem()).getCore().getEn().getPrompt()))
                .convert(new File(directory, itemResponse.getItem().getId() + "-dup.pdf").getPath());
    }

    private static void pack(final Path folder, final Path zipFilePath) throws IOException {
        try (
                FileOutputStream fos = new FileOutputStream(zipFilePath.toFile());
                ZipOutputStream zos = new ZipOutputStream(fos)
        ) {
            Files.walkFileTree(folder, new SimpleFileVisitor<Path>() {
                public FileVisitResult visitFile(Path file, BasicFileAttributes attrs) throws IOException {
                    zos.putNextEntry(new ZipEntry(folder.relativize(file).toString()));
                    Files.copy(file, zos);
                    zos.closeEntry();
                    return FileVisitResult.CONTINUE;
                }

                public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) throws IOException {
                    zos.putNextEntry(new ZipEntry(folder.relativize(dir).toString() + "/"));
                    zos.closeEntry();
                    return FileVisitResult.CONTINUE;
                }
            });
        }
    }

    private void doSomethin(String itemId) {
        ItemBankUser user = new ItemBankUser("tmiller@fairwaytech.com", "Todd");
        PreviewData data = itemRepository.cloneItemForPreview(user, itemId, StringUtils.EMPTY,  "iat-development");

        log.info("Location is " + data);
    }

    private void getPreview(File directory, String itemId) {
        ResponseEntity<Some> responseEntity = restTemplate.getForEntity("http://localhost:8083/api/v1/items/" + itemId, Some.class);

        String renderUrl = responseEntity.getBody().renderUrl;

        boolean success = HtmlToPdf.create()
                .object(HtmlToPdfObject.forUrl("https://www.google.com/"))
                .convert(new File(directory, itemId + "-renderedHtml.pdf").getPath());
    }

    private static class Some {
        private String renderUrl;

        public String getRenderUrl() {
            return renderUrl;
        }

        public void setRenderUrl(final String renderUrl) {
            this.renderUrl = renderUrl;
        }
    }
}
